<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>FC-Betenmacher – Auswertung (Beamer)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background:#000;
      color:#fff;
      margin:0;
      padding:0;
    }
    .container {
      max-width:1400px;
      margin:0 auto;
      padding:20px 40px;
    }
    h1 {
      text-align:center;
      font-size:42px;
      margin:10px 0 5px;
    }
    h2 {
      text-align:center;
      font-size:28px;
      margin:10px 0 5px;
    }
    #count {
      font-size:26px;
      text-align:center;
      margin-top:10px;
    }
    .card {
      background:transparent;
      border:none;
      margin-bottom:40px;
    }
    .chart-wrapper {
      height:450px;
    }
    #status {
      text-align:center;
      font-size:16px;
      opacity:0.9;
      margin-top:8px;
    }
  </style>
</head>
<body>

<div id="app" class="container">
  <h1>FC-Betenmacher – Auswertung</h1>

  <div class="card">
    <p id="count">Lade …</p>
    <div id="status"></div>
  </div>

  <div class="card">
    <h2>Sportarten</h2>
    <div class="chart-wrapper">
      <canvas id="sportChart"></canvas>
    </div>
  </div>

  <div class="card">
    <h2>Sonstiges</h2>
    <div class="chart-wrapper">
      <canvas id="otherChart"></canvas>
    </div>
  </div>
</div>

<script>
/* ===================== Firebase ===================== */
const firebaseConfig = {
  apiKey: "AIzaSyCRkIU7F42QPrs2oMOymQxF4MVKM7oQZTw",
  authDomain: "fc-betenmacher-bewerbswa-b44e4.firebaseapp.com",
  databaseURL: "https://fc-betenmacher-bewerbswa-b44e4-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "fc-betenmacher-bewerbswa-b44e4",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ===================== State ===================== */
let sportChart = null;
let otherChart = null;

function setStatus(text) {
  const el = document.getElementById('status');
  if (el) el.textContent = text || "";
}

/* ===================== Plugin: Text IM Balken (erst wenn Balken fertig) ===================== */
const valueLabelPlugin = {
  id: 'valueLabel',
  afterDatasetsDraw(chart) {
    const { ctx } = chart;
    const meta = chart.getDatasetMeta(0);
    const data = chart.data;
    if (!meta || !meta.data || meta.data.length === 0) return;

    const xScale = chart.scales.x;

    ctx.save();
    ctx.font = '16px Arial';
    ctx.fillStyle = '#000';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';

    meta.data.forEach((bar, i) => {
      const value = data.datasets[0].data[i];
      const label = data.labels[i];
      const suffix = (data.suffixes && data.suffixes[i]) ? data.suffixes[i] : "";
      const text = `${label} (${value})${suffix}`;

      // Nur anzeigen, wenn der Balken wirklich am Ziel ist
      const targetX = xScale.getPixelForValue(value);
      const tolerance = 1.5; // Pixel-Toleranz
      if (Math.abs(bar.x - targetX) > tolerance) return;

      const centerX = (bar.x + bar.base) / 2;
      const centerY = bar.y;
      ctx.fillText(text, centerX, centerY);
    });

    ctx.restore();
  }
};

/* ===================== Helpers ===================== */
function sortEntries(obj) {
  return Object.entries(obj)
    .sort((a, b) => b[1] - a[1] || String(a[0]).localeCompare(String(b[0]), 'de'));
}
function safeArray(x) { return Array.isArray(x) ? x : []; }

function computeCounts(votesObj) {
  const sport = {};
  const other = {};
  let total = 0;

  Object.values(votesObj || {}).forEach(v => {
    if (!v || typeof v !== 'object') return;
    total++;

    safeArray(v.sport).forEach(s => { sport[s] = (sport[s] || 0) + 1; });
    safeArray(v.other).forEach(o => { other[o] = (other[o] || 0) + 1; });
  });

  return { sport, other, total };
}

function pickOverallErsatz(sportEntries, otherEntries) {
  const sportRest = sportEntries.slice(3).map(([label, count]) => ({ cat: "sport", label, count }));
  const otherRest = otherEntries.slice(3).map(([label, count]) => ({ cat: "other", label, count }));

  const candidates = sportRest.concat(otherRest);
  if (candidates.length === 0) return null;

  candidates.sort((a, b) => b.count - a.count || String(a.label).localeCompare(String(b.label), 'de'));
  return candidates[0]; // {cat,label,count}
}

/* ===================== Farben + Suffix ===================== */
function prepareData(entries, ersatzName) {
  const labels = entries.map(e => e[0]);
  const values = entries.map(e => e[1]);

  const suffixes = [];
  const colors = [];

  labels.forEach((label, i) => {
    let suffix = "";
    if (ersatzName && label === ersatzName) suffix = " (Ersatzbewerb)";
    suffixes.push(suffix);

    if (i < 3) colors.push("rgba(34,197,94,0.85)");
    else if (ersatzName && label === ersatzName) colors.push("rgba(234,179,8,0.9)");
    else colors.push("rgba(148,163,184,0.9)");
  });

  return { labels, values, colors, suffixes };
}

/* ===================== Chart Rendering ===================== */
function drawChart(id, entries, type, ersatzName) {
  if (type === "sport" && sportChart) sportChart.destroy();
  if (type === "other" && otherChart) otherChart.destroy();

  const { labels, values, colors, suffixes } = prepareData(entries, ersatzName);
  const ersatzIndex = ersatzName ? labels.indexOf(ersatzName) : -1;
  const maxVal = Math.max(0, ...values);

  const canvas = document.getElementById(id);
  if (!canvas) return;
  const ctx = canvas.getContext("2d");

  const chart = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      suffixes,
      datasets: [{
        data: values,
        backgroundColor: colors
      }]
    },
    options: {
      indexAxis: "y",
      responsive: true,
      maintainAspectRatio: false,

      // Balken mit wenig Stimmen schneller, Maximum ca. 15s
      animations: {
        x: {
          from: 0,
          duration: (ctx) => {
            const v = Number(ctx.raw || 0);
            if (!maxVal) return 0;
            const ms = Math.round(15000 * (v / maxVal)); // <= HIER: 15000 = max. 15s
            return Math.max(250, ms); // Minimum, damit man es sieht
          }
        },
        y: { duration: 0 } // Position nicht animieren
      },

      plugins: {
        legend: { display:false },
        tooltip: { enabled:true }
      },
      scales: {
        x: {
          beginAtZero:true,
          ticks:{ display:false },
          grid:{ display:false }
        },
        y: {
          ticks: {
            display: true,
            color: "#fff",
            callback: (v, i) => {
              if (i < 3) return String(i + 1);      // 1,2,3 links
              if (ersatzIndex === i) return "E";    // Ersatzbewerb
              return "";                             // sonst nichts
            }
          },
          grid:{ display:false }
        }
      }
    },
    plugins:[valueLabelPlugin]
  });

  if (type === "sport") sportChart = chart;
  else otherChart = chart;
}

/* ===================== Load ===================== */
db.ref('votes').once('value').then(snap => {
  const votes = snap.val() || {};
  const { sport, other, total } = computeCounts(votes);

  document.getElementById('count').innerText = 'Abgegebene Stimmen: ' + total;

  const sportEntries = sortEntries(sport);
  const otherEntries = sortEntries(other);

  const ersatz = pickOverallErsatz(sportEntries, otherEntries);

  drawChart("sportChart", sportEntries, "sport", ersatz && ersatz.cat === "sport" ? ersatz.label : null);
  drawChart("otherChart", otherEntries, "other", ersatz && ersatz.cat === "other" ? ersatz.label : null);

  setStatus("Stand: " + new Date().toLocaleString('de-AT'));
}).catch(err => {
  console.error("Fehler beim Lesen von /votes:", err);
  document.getElementById('count').innerText = 'Fehler beim Laden.';
  setStatus("Fehler: " + (err && err.message ? err.message : "Keine Berechtigung (Rules) oder Netzwerkproblem."));
});
</script>
</body>
</html>
