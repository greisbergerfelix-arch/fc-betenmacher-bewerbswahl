<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>FC-Betenmacher – Auswertung (Beamer)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background:#000;
      color:#fff;
      margin:0;
      padding:0;
    }
    .container {
      max-width:1400px;
      margin:0 auto;
      padding:20px 40px;
    }
    h1 {
      text-align:center;
      font-size:42px;
      margin:10px 0 5px;
    }
    h2 {
      text-align:center;
      font-size:28px;
      margin:10px 0 5px;
    }
    #count {
      font-size:26px;
      text-align:center;
      margin-top:10px;
    }
    .card {
      background:transparent;
      border:none;
      margin-bottom:40px;
    }
    .chart-wrapper {
      height:450px;
    }

    /* Statuszeile */
    #status {
      text-align:center;
      font-size:16px;
      opacity:0.9;
      margin-top: 8px;
    }
  </style>
</head>
<body>

<div id="app" class="container">
  <h1>FC-Betenmacher – Auswertung</h1>

  <div class="card">
    <p id="count">Lade …</p>
    <div id="status"></div>
  </div>

  <div class="card">
    <h2>Sportarten</h2>
    <div class="chart-wrapper">
      <canvas id="sportChart"></canvas>
    </div>
  </div>

  <div class="card">
    <h2>Sonstiges</h2>
    <div class="chart-wrapper">
      <canvas id="otherChart"></canvas>
    </div>
  </div>

</div>

<script>
/* ===================== Firebase ===================== */
const firebaseConfig = {
  apiKey: "AIzaSyCRkIU7F42QPrs2oMOymQxF4MVKM7oQZTw",
  authDomain: "fc-betenmacher-bewerbswa-b44e4.firebaseapp.com",
  databaseURL: "https://fc-betenmacher-bewerbswa-b44e4-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "fc-betenmacher-bewerbswa-b44e4",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ===================== State ===================== */
let sportChart = null;
let otherChart = null;

function setStatus(text) {
  const el = document.getElementById('status');
  if (!el) return;
  el.textContent = text || "";
}

/* ===================== Plugin: Text im Balken ===================== */
const valueLabelPlugin = {
  id: 'valueLabel',
  afterDatasetsDraw(chart) {
    const { ctx } = chart;
    const meta = chart.getDatasetMeta(0);
    const data = chart.data;

    if (!meta || !meta.data || meta.data.length === 0) return;

    ctx.save();
    ctx.font = '16px Arial';
    ctx.fillStyle = '#000';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';

    meta.data.forEach((bar, i) => {
      const value = data.datasets[0].data[i];
      const label = (data.originalLabels && data.originalLabels[i]) ? data.originalLabels[i] : data.labels[i];
      const suffix = (data.suffixes && data.suffixes[i]) ? data.suffixes[i] : "";
      const text = `${label} (${value})${suffix}`;

      const centerX = (bar.x + bar.base) / 2;
      const centerY = bar.y;

      ctx.fillText(text, centerX, centerY);
    });

    ctx.restore();
  }
};

/* ===================== Helpers ===================== */
function sortEntries(obj) {
  return Object.entries(obj)
    .sort((a, b) => b[1] - a[1] || String(a[0]).localeCompare(String(b[0]), 'de'));
}

function safeArray(x) {
  return Array.isArray(x) ? x : [];
}

function computeCounts(votesObj) {
  const sport = {};
  const other = {};
  let total = 0;

  Object.values(votesObj || {}).forEach(v => {
    if (!v || typeof v !== 'object') return;
    total++;

    safeArray(v.sport).forEach(s => { sport[s] = (sport[s] || 0) + 1; });
    safeArray(v.other).forEach(o => { other[o] = (other[o] || 0) + 1; });
  });

  return { sport, other, total };
}

function pickOverallErsatz(sportEntries, otherEntries) {
  const sportRest = sportEntries.slice(3).map(([label, count]) => ({ cat: "sport", label, count }));
  const otherRest = otherEntries.slice(3).map(([label, count]) => ({ cat: "other", label, count }));

  const candidates = sportRest.concat(otherRest);
  if (candidates.length === 0) return null;

  candidates.sort((a, b) => b.count - a.count || String(a.label).localeCompare(String(b.label), 'de'));
  return candidates[0]; // {cat,label,count}
}

/* ====== NEU: Farb-/Suffix-Logik (Top3 grün, 1 globaler Ersatz gelb, Rest grau) ====== */
function prepareData(entries, ersatzName) {
  const labels = entries.map(e => e[0]);
  const values = entries.map(e => e[1]);

  const suffixes = [];
  const colors = [];

  labels.forEach((label, i) => {
    let suffix = "";
    if (ersatzName && label === ersatzName) suffix = " (Ersatzbewerb)";
    suffixes.push(suffix);

    if (i < 3) colors.push("rgba(34,197,94,0.85)");                 // Top 3 grün
    else if (ersatzName && label === ersatzName) colors.push("rgba(234,179,8,0.9)"); // genau 1 gelb
    else colors.push("rgba(148,163,184,0.9)");                       // Rest grau
  });

  return { labels, values, colors, suffixes };
}

/* ===================== Chart Rendering ===================== */
function drawChart(id, entries, type, ersatzName) {
  if (type === "sport" && sportChart) sportChart.destroy();
  if (type === "other" && otherChart) otherChart.destroy();

  const { labels, values, colors, suffixes } = prepareData(entries, ersatzName);
  const canvas = document.getElementById(id);
  if (!canvas) return;
  const ctx = canvas.getContext("2d");

  const chart = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      originalLabels: labels,
      suffixes,
      datasets: [{
        data: values,
        backgroundColor: colors
      }]
    },
    options: {
      indexAxis: "y",
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      plugins: {
        legend: { display:false },
        tooltip:{ enabled:true }
      },
      scales: {
        x: {
          beginAtZero:true,
          ticks:{ display:false },
          grid:{ display:false }
        },
        y: {
          ticks: {
            color:"#fff",
            callback:(v,i)=> (i < 3 ? (i+1) : "")
          },
          categoryPercentage: 0.6,
          barPercentage: 0.8,
          grid:{ display:false }
        }
      }
    },
    plugins:[valueLabelPlugin]
  });

  if (type === "sport") sportChart = chart;
  else otherChart = chart;
}

/* ===================== Live Load ===================== */
function loadData() {
  setStatus("Verbinde mit Datenbank …");

  db.ref('votes').on('value',
    (snap) => {
      const votes = snap.val() || {};
      const { sport, other, total } = computeCounts(votes);

      document.getElementById('count').innerText = 'Abgegebene Stimmen: ' + total;

      const sportEntries = sortEntries(sport);
      const otherEntries = sortEntries(other);

      // genau 1 Ersatzbewerb insgesamt (bester außerhalb Top 3 aus beiden Kategorien)
      const ersatz = pickOverallErsatz(sportEntries, otherEntries);

      // Beide Charts zeigen ALLE Einträge, aber nur EINE Kategorie bekommt den gelben Ersatz
      drawChart("sportChart", sportEntries, "sport", ersatz && ersatz.cat === "sport" ? ersatz.label : null);
      drawChart("otherChart", otherEntries, "other", ersatz && ersatz.cat === "other" ? ersatz.label : null);

      setStatus("Live-Stand: " + new Date().toLocaleString('de-AT'));
    },
    (err) => {
      console.error("Fehler beim Lesen von /votes:", err);
      document.getElementById('count').innerText = 'Fehler beim Laden.';
      setStatus("Fehler: " + (err && err.message ? err.message : "Keine Berechtigung (Rules) oder Netzwerkproblem."));
    }
  );
}

loadData();
</script>
</body>
</html>
