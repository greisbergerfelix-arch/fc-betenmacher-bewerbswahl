<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>FC-Betenmacher – Bewerbswahl</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background:#f4f6f8;
      margin:0;
      padding:20px;
    }
    .container {
      max-width:900px;
      margin:0 auto;
    }
    .card {
      background:#fff;
      padding:20px;
      border-radius:12px;
      box-shadow:0 4px 10px rgba(0,0,0,0.08);
      margin-bottom:20px;
      position:relative;
    }
    h1 {
      margin:0;
      margin-bottom:10px;
    }
    .note {
      text-align:center;
      color:#555;
      font-size:14px;
    }
    .grid {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap:8px;
    }
    label.option-label {
      display:flex;
      align-items:flex-start;
      gap:8px;
      line-height:1.3;
      font-size:14px;
    }
    label.option-label input[type="checkbox"] {
      margin-top:2px;
    }
    button {
      padding:10px 16px;
      border:none;
      border-radius:8px;
      font-size:16px;
      background:#2563eb;
      color:#fff;
      cursor:pointer;
    }
    button:disabled {
      opacity:0.6;
      cursor:default;
    }
    #birthdate {
      font-size:16px;
      padding:6px 10px;
      width:160px;
      text-align:center;
    }
    .birth-wrapper {
      margin:10px 0 0;
      text-align:center;
    }
    .birth-hint {
      font-size:13px;
      color:#555;
      margin-top:6px;
      max-width:650px;
      margin-left:auto;
      margin-right:auto;
    }
    .info-banner {
      background:#ffeeba;
      border:1px solid #f0ad4e;
      color:#856404;
      padding:12px;
      margin-bottom:15px;
      border-radius:6px;
      font-size:15px;
      text-align:center;
    }
  </style>
</head>
<body>

<div class="container" id="pageContainer">

  <!-- Info-Banner (wird ggf. per JS eingefügt) -->

  <!-- Titelkarte mit Logos -->
  <div class="card" style="padding-top:60px; padding-bottom:40px; text-align:center; margin-bottom:35px;">

    <!-- Logo links -->
    <img src="00_Logo_freigestellt.png"
         style="position:absolute; left:25px; top:25px; height:85px; width:auto;"
         alt="Vereinslogo links">

    <!-- Logo rechts -->
    <img src="00_Logo_freigestellt.png"
         style="position:absolute; right:25px; top:25px; height:85px; width:auto;"
         alt="Vereinslogo rechts">

    <h1>FC-Betenmacher – Bewerbswahl</h1>
    <p class="note">
      Bitte wähle <strong>genau 3 Sportarten</strong> und <strong>genau 3 Sonstiges</strong>.<br>
      (*) = gesperrt aufgrund der 3-Jahres-Regel
    </p>
  </div>

  <!-- Geburtsdatum -->
  <div class="card">
    <div class="birth-wrapper">
      <label for="birthdate" style="display:flex; flex-direction:column; gap:8px; align-items:center;">
        <span><strong>Geburtsdatum eingeben (TTMMJJJJ):</strong></span>
        <input
          type="text"
          id="birthdate"
          maxlength="10"
          placeholder="TTMMJJJJ"
          autocomplete="off"
        >
      </label>
      <p class="birth-hint">
        xxxDas Geburtsdatum wird ausschließlich dafür verwendet, um sicherzustellen, dass jede Person nur
        einmal anonym abstimmt. In der Datenbank werden keine Namen, Mitgliedsnummern oder andere
        persönlichen Daten gespeichert, die Rückschlüsse darauf erlauben, wer welche Auswahl getroffen hat.
      </p>
    </div>
  </div>

  <!-- Sportarten -->
  <div class="card">
    <h2>Sportarten</h2>
    <div class="grid" id="sports"></div>
  </div>

  <!-- Sonstiges -->
  <div class="card">
    <h2>Sonstiges</h2>
    <div class="grid" id="others"></div>
  </div>

  <!-- Button -->
  <div class="card" style="text-align:center">
    <button id="btnSubmit" onclick="submitVote()">Stimme abgeben</button>
    <p id="status" class="note"></p>
  </div>

</div>

<script>
// ===================== Firebase-Konfiguration =====================
const firebaseConfig = {
  apiKey: "AIzaSyCRkIU7F42QPrs2oMOymQxF4MVKM7oQZTw",
  authDomain: "fc-betenmacher-bewerbswa-b44e4.firebaseapp.com",
  databaseURL: "https://fc-betenmacher-bewerbswa-b44e4-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "fc-betenmacher-bewerbswa-b44e4",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ===================== Device-ID pro Gerät =====================
function getDeviceId() {
  const KEY = 'fc_betenmacher_device_id';
  let id = localStorage.getItem(KEY);
  if (!id) {
    if (window.crypto && crypto.randomUUID) {
      id = crypto.randomUUID();
    } else {
      id = 'dev-' + Math.random().toString(36).slice(2) + Date.now().toString(36);
    }
    localStorage.setItem(KEY, id);
  }
  return id;
}
const DEVICE_ID = getDeviceId();

// ===================== Optionen =====================
const sportOptions = [
  'Weitsprung',
  'Fuschlseelauf*',
  'Mountainbikerennen*',
  'Triathlon',
  'Paddle Tennis³',
  'Sackhüpfen mit Hindernisparkour',
  'Schlagball',
  'Hindernisparkour Halle',
  'Lauf Moos - Bettei',
  'Ski fahren',
  'Skilanglauf²',
  '1500-Meter-Lauf*',
  'Tischtennis*',
  'Badminton*',
  'Kart fahren (mit Selbstbehalt)',
  'Torabschlag',
  'Seil ziehen',
  'Hindernislauf im Freien',
  'Bierkistenlauf*',
  'Biathlon²',
  '100 Meter Schwimmen',
  'Tennis³*',
  'Kugelstoßen',
  'Maßkrugstemmen',
  'Volleyball 2 vs 2',
  'Klettern',
  'Dreikampf (Standweitsprung, Bierdeckel Ziel werfen, an Reckstange hängen)'
];

const otherOptions = [
  'Darts*',
  'Holzstocknageln',
  'Eisstockschießen/Asphaltschießen*',
  'Basketballfreiwurf',
  'Elfmeterschießen*',
  'Tischfußball',
  'Fußball-Darts',
  'Fußball-Golf',
  'Quizduell',
  'Bogenschießen*',
  'Kegeln²*',
  'Dosenwerfen',
  'Minigolf',
  'Bierpong*',
  'Wattturnier',
  '8-Billard',
  'Cornehole',
  '3D-4-Gewinnt',
  'Zimmergewehrschießen*',
  'Bowling²*',
  'Torwandschießen',
  'Plattenwerfen',
  'Schätzen',
  'FIFA-Turnier',
  'Papierfliegerweitwurf',
  'Fussball - Lattenkrachen',
  'Bauern-Olympiade (Gummistiefel Zielwurf, Hufeisenwerfen, Baumstamm sägen)'
];

// ===================== Rendering =====================
function renderOptions(list, containerId, type) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  list.forEach(text => {
    const disabled = text.includes('*') ? 'disabled' : '';
    const label = document.createElement('label');
    label.className = 'option-label';
    label.innerHTML = `
      <input type="checkbox" data-type="${type}" value="${text}" ${disabled}>
      <span>${text}</span>
    `;
    container.appendChild(label);
  });
}

// ===================== Geburtsdatum: nur Zahlen, Auto-Format TT-MM-JJJJ =====================
document.addEventListener('DOMContentLoaded', () => {
  const birthField = document.getElementById('birthdate');
  if (!birthField) return;

  birthField.addEventListener('input', (e) => {
    let v = e.target.value;
    // alles außer Ziffern entfernen
    v = v.replace(/\D/g, '');
    // max. 8 Ziffern (TTMMJJJJ)
    if (v.length > 8) v = v.slice(0, 8);

    let formatted = v;
    if (v.length > 4) {
      formatted = v.slice(0,2) + '-' + v.slice(2,4) + '-' + v.slice(4);
    } else if (v.length > 2) {
      formatted = v.slice(0,2) + '-' + v.slice(2);
    }

    e.target.value = formatted;
  });
});

// Hilfsfunktion: TT-MM-JJJJ -> Validierung + YYYY-MM-DD
function parseBirthdate(input) {
  const m = /^(\d{2})-(\d{2})-(\d{4})$/.exec(input);
  if (!m) return null;
  const dd = parseInt(m[1], 10);
  const mm = parseInt(m[2], 10);
  const yyyy = parseInt(m[3], 10);

  if (mm < 1 || mm > 12) return null;
  if (dd < 1 || dd > 31) return null;

  const d = new Date(yyyy, mm - 1, dd);
  if (
    d.getFullYear() !== yyyy ||
    d.getMonth() !== (mm - 1) ||
    d.getDate() !== dd
  ) {
    return null;
  }

  const iso = `${yyyy.toString().padStart(4,'0')}-${mm.toString().padStart(2,'0')}-${dd.toString().padStart(2,'0')}`;
  return { display: input, key: iso };
}

// ===================== Gerät hat schon abgestimmt? =====================
function checkExistingVote() {
  const deviceRef = db.ref('deviceVotes/' + DEVICE_ID);
  deviceRef.once('value').then(snap => {
    if (snap.exists()) {
      const banner = document.createElement('div');
      banner.className = 'info-banner';
      banner.textContent = 'Du hast bereits abgestimmt. Vielen Dank!';
      const container = document.getElementById('pageContainer');
      container.insertBefore(banner, container.firstChild);

      const btn = document.getElementById('btnSubmit');
      if (btn) btn.disabled = true;
    }
  }).catch(err => {
    console.error('Fehler beim Prüfen von deviceVotes:', err);
  });
}

// ===================== Abstimmung senden =====================
async function submitVote() {
  const selectedSports = [...document.querySelectorAll('[data-type=sport]:checked')];
  const selectedOthers = [...document.querySelectorAll('[data-type=other]:checked')];
  const birthField = document.getElementById('birthdate');
  const birthRaw = birthField ? birthField.value.trim() : '';
  const statusEl = document.getElementById('status');
  const btn = document.getElementById('btnSubmit');

  statusEl.textContent = '';

  if (!birthRaw) {
    alert('Bitte gib dein Geburtsdatum ein (TTMMJJJJ).');
    return;
  }

  const parsed = parseBirthdate(birthRaw);
  if (!parsed) {
    alert('Das Geburtsdatum ist ungültig. Bitte im Format TTMMJJJJ eingeben.');
    return;
  }

  const birthDisplay = parsed.display; // TT-MM-JJJJ
  const birthKey = parsed.key;        // YYYY-MM-DD

  if (selectedSports.length !== 3 || selectedOthers.length !== 3) {
    alert('Bitte genau 3 Sportarten und genau 3 Sonstiges auswählen.');
    return;
  }

  btn.disabled = true;
  statusEl.textContent = 'Bitte warten, Stimme wird geprüft …';

  try {
    // 1) Gerät schon abgestimmt?
    const deviceSnap = await db.ref('deviceVotes/' + DEVICE_ID).once('value');
    if (deviceSnap.exists()) {
      alert('Dieses Gerät hat bereits abgestimmt. Mehrfach-Abstimmungen sind nicht erlaubt.');
      btn.disabled = false;
      statusEl.textContent = '';
      return;
    }

    // 2) Anwesenheit prüfen
    let presentSnap;
    try {
      presentSnap = await db.ref('present/' + birthKey).once('value');
    } catch (err) {
      console.error('Fehler beim Lesen von /present:', err);
      alert('Interner Fehler: Anwesenheitsliste konnte nicht geprüft werden. Bitte wende dich an die Wahlleitung.');
      btn.disabled = false;
      statusEl.textContent = '';
      return;
    }

    if (!presentSnap.exists()) {
      alert('Du bist für diese Abstimmung nicht als anwesend markiert. Bitte melde dich bei der Wahlleitung.');
      btn.disabled = false;
      statusEl.textContent = '';
      return;
    }

    // 3) Für dieses Geburtsdatum schon eine Stimme?
    const voteSnap = await db.ref('votes/' + birthKey).once('value');
    if (voteSnap.exists()) {
      alert('Für dieses Geburtsdatum wurde bereits eine Stimme abgegeben.');
      btn.disabled = false;
      statusEl.textContent = '';
      return;
    }

    // 4) Alles OK -> speichern
    const vote = {
      birthdate: birthDisplay,
      sport: selectedSports.map(x => x.value),
      other: selectedOthers.map(x => x.value),
      ts: Date.now()
    };

    const updates = {};
    updates['votes/' + birthKey] = vote;
    updates['deviceVotes/' + DEVICE_ID] = {
      birthdate: birthDisplay,
      ts: Date.now()
    };

    await db.ref().update(updates);

    document.body.innerHTML =
      '<h2 style="text-align:center;margin-top:50px;">Danke für deine Stimme!</h2>';

  } catch (err) {
    console.error('Fehler beim Speichern der Stimme:', err);
    alert('Beim Speichern ist ein Fehler aufgetreten. Bitte später erneut versuchen oder die Wahlleitung informieren.');
    btn.disabled = false;
    statusEl.textContent = '';
  }
}

// ===================== Initialisierung =====================
renderOptions(sportOptions, 'sports', 'sport');
renderOptions(otherOptions, 'others', 'other');
checkExistingVote();
</script>

</body>
</html>
