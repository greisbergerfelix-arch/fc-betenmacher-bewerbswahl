<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>FC-Betenmacher – Abstimmungsstatus Mitglieder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background:#f4f6f8;
      margin:0;
      padding:20px;
    }
    .container {
      max-width:1200px;
      margin:0 auto;
    }
    .card {
      background:#fff;
      padding:20px;
      border-radius:12px;
      box-shadow:0 4px 10px rgba(0,0,0,0.08);
      margin-bottom:20px;
    }
    h1 { text-align:center; margin-top:0; }
    h2 { margin:0 0 10px; }

    .muted { color:#6b7280; font-size:13px; }
    .grid {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap:12px;
      margin-top:12px;
    }
    .stat {
      background:#f9fafb;
      border:1px solid #e5e7eb;
      border-radius:10px;
      padding:12px;
    }
    .stat .k { font-size:13px; color:#6b7280; }
    .stat .v { font-size:22px; font-weight:700; margin-top:4px; }

    .row {
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:10px;
    }
    button {
      padding:10px 14px;
      border:none;
      border-radius:10px;
      background:#2563eb;
      color:#fff;
      cursor:pointer;
      font-size:14px;
    }
    button.secondary {
      background:#111827;
    }

    table {
      width:100%;
      border-collapse:collapse;
      font-size:14px;
    }
    th, td {
      padding:6px 8px;
      border-bottom:1px solid #e5e7eb;
      text-align:left;
      white-space:nowrap;
    }
    th {
      background:#f3f4f6;
      font-weight:600;
      position:sticky;
      top:0;
      z-index:1;
    }
    tr:nth-child(even) td { background:#f9fafb; }
    .scrollX { overflow-x:auto; }
    .scrollY { max-height:520px; overflow:auto; border:1px solid #e5e7eb; border-radius:10px; }

    .ok { color:#16a34a; font-weight:600; }
    .warn { color:#d97706; font-weight:600; }
    .bad { color:#dc2626; font-weight:600; }
    .tiny { font-size:12px; color:#6b7280; }
    .errorBox {
      background:#fef2f2;
      border:1px solid #fecaca;
      color:#991b1b;
      padding:12px;
      border-radius:10px;
      display:none;
      margin-top:12px;
      white-space:pre-wrap;
    }
  </style>
</head>
<body>

<div class="container">

  <div class="card">
    <h1>Abstimmungsstatus Mitglieder</h1>
    <p class="muted">
      Interne Übersicht. Diese Seite sollte nicht öffentlich geteilt werden.
    </p>

    <div class="grid">
      <div class="stat">
        <div class="k">Mitglieder in Liste</div>
        <div class="v" id="stMembers">–</div>
      </div>
      <div class="stat">
        <div class="k">Anwesend / stimmberechtigt (present)</div>
        <div class="v" id="stPresent">–</div>
      </div>
      <div class="stat">
        <div class="k">Stimmberechtigt & abgestimmt</div>
        <div class="v" id="stEligibleVoted">–</div>
      </div>
      <div class="stat">
        <div class="k">Stimmberechtigt & noch nicht abgestimmt</div>
        <div class="v" id="stEligibleNotVoted">–</div>
      </div>
      <div class="stat">
        <div class="k">Nicht stimmberechtigt (nicht anwesend)</div>
        <div class="v" id="stNotEligible">–</div>
      </div>
      <div class="stat">
        <div class="k">Anwesend, aber nicht in Mitgliederliste</div>
        <div class="v" id="stPresentUnknown">–</div>
      </div>
    </div>

    <div class="row">
      <button onclick="reloadAll()">Neu laden</button>
      <button class="secondary" onclick="exportCSV()">CSV Export (stimmberechtigt)</button>
      <span class="tiny">CSV exportiert: stimmberechtigt (anwesend) inkl. Status “abgestimmt / nicht”.</span>
    </div>

    <div id="err" class="errorBox"></div>
  </div>

  <div class="card">
    <h2>Stimmberechtigt & bereits abgestimmt</h2>
    <p class="muted">Mitglieder, die in <code>present</code> stehen und eine Stimme in <code>votes</code> haben.</p>
    <div class="scrollX scrollY">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Nachname</th>
            <th>Vorname</th>
            <th>Geburtsdatum</th>
            <th>Stimmabgabe</th>
          </tr>
        </thead>
        <tbody id="tbEligibleVoted">
          <tr><td colspan="5" class="muted">Daten werden geladen …</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <h2>Stimmberechtigt & noch nicht abgestimmt</h2>
    <p class="muted">Mitglieder, die in <code>present</code> stehen, aber noch keine Stimme in <code>votes</code> haben.</p>
    <div class="scrollX scrollY">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Nachname</th>
            <th>Vorname</th>
            <th>Geburtsdatum</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="tbEligibleNotVoted">
          <tr><td colspan="5" class="muted">Daten werden geladen …</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <h2>Nicht stimmberechtigt (nicht anwesend)</h2>
    <p class="muted">Mitglieder aus der Liste, die nicht in <code>present</code> stehen.</p>
    <div class="scrollX scrollY">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Nachname</th>
            <th>Vorname</th>
            <th>Geburtsdatum</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="tbNotEligible">
          <tr><td colspan="5" class="muted">Daten werden geladen …</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <h2>Anwesend, aber nicht in Mitgliederliste</h2>
    <p class="muted">Alle Keys aus <code>present</code>, die keinem Mitglied zugeordnet werden können (Checkliste).</p>
    <div class="scrollX scrollY">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>present-Key (YYYY-MM-DD)</th>
            <th>Hinweis</th>
          </tr>
        </thead>
        <tbody id="tbPresentUnknown">
          <tr><td colspan="3" class="muted">Daten werden geladen …</td></tr>
        </tbody>
      </table>
    </div>
  </div>

</div>

<script>
  // Firebase-Konfiguration
  const firebaseConfig = {
    apiKey: "AIzaSyCRkIU7F42QPrs2oMOymQxF4MVKM7oQZTw",
    authDomain: "fc-betenmacher-bewerbswa-b44e4.firebaseapp.com",
    databaseURL: "https://fc-betenmacher-bewerbswa-b44e4-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "fc-betenmacher-bewerbswa-b44e4",
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Mitgliederliste
  const members = [
    { nr: 1, last: "Anglberger", first: "Lukas", birth: "05.08.2001"},
    { nr: 2, last: "Auswöger", first: "Alexander", birth: "07.10.1982"},
    { nr: 3, last: "Auswöger", first: "Mario", birth: "25.07.1981"},
    { nr: 4, last: "Bormann", first: "Heiko", birth: "12.02.1977"},
    { nr: 5, last: "Brandstätter", first: "Fabian", birth: "16.04.1998"},
    { nr: 6, last: "Eisl", first: "Karl", birth: "24.05.1961"},
    { nr: 7, last: "Enzesberger", first: "Alois", birth: "21.12.1991"},
    { nr: 8, last: "Enzesberger", first: "Gerhard sen.", birth: "26.08.1961"},
    { nr: 9, last: "Enzesberger", first: "Gerhard jun.", birth: "14.02.1987"},
    { nr:10, last: "Eppenschwandtner", first: "Franz", birth:"28.05.1961"},
    { nr:11, last: "Eppenschwandtner", first: "Georg", birth:"23.02.1979"},
    { nr:12, last: "Eppenschwandtner", first: "Stefan", birth:"14.09.1986"},
    { nr:13, last: "Feistritzer", first: "Philipp", birth:"20.01.1982"},
    { nr:14, last: "Greinz-Einberger", first:"Andreas", birth:"20.06.1988"},
    { nr:15, last: "Greinz-Einberger", first:"Ferdinand", birth:"08.08.1961"},
    { nr:16, last: "Greinz-Einberger", first:"Lukas", birth:"20.09.2001"},
    { nr:17, last: "Greisberger", first:"Andreas", birth:"21.06.1996"},
    { nr:18, last: "Greisberger", first:"Felix (Freez)", birth:"04.05.1987"},
    { nr:19, last: "Greisberger", first:"Franz", birth:"28.11.1960"},
    { nr:20, last: "Greisberger", first:"Georg", birth:"18.04.1983"},
    { nr:21, last: "Greisberger", first:"Jakob", birth:"14.08.2002"},
    { nr:22, last: "Greisberger", first:"Thomas", birth:"03.01.1984"},
    { nr:23, last: "Greisberger", first:"Toni", birth:"19.12.1960"},
    { nr:24, last: "Gruber", first:"Bernhard", birth:"06.09.1993"},
    { nr:25, last: "Gruber", first:"Matthias", birth:"21.12.1960"},
    { nr:26, last: "Grubinger", first:"Gerhard", birth:"11.06.1973"},
    { nr:27, last: "Grubinger", first:"John", birth:"02.10.1971"},
    { nr:28, last: "Lemberger", first:"Norbert", birth:"23.07.1994"},
    { nr:29, last: "Lichtmannsperger", first:"Martin", birth:"20.02.1971"},
    { nr:30, last: "Meindl", first:"Martin", birth:"01.02.1978"},
    { nr:31, last: "Niederbrucker", first:"Hans", birth:"04.06.1944"},
    { nr:32, last: "Niederbrucker", first:"Hans-Jürgen", birth:"02.02.1975"},
    { nr:33, last: "Oberascher", first:"Ferdinand", birth:"29.11.1960"},
    { nr:34, last: "Oberascher", first:"Patrick", birth:"05.07.1995"},
    { nr:35, last: "Oberascher", first:"Sebastian", birth:"21.02.1967"},
    { nr:36, last: "Pichler", first:"David", birth:"20.07.1985"},
    { nr:37, last: "Reiter", first:"Roland", birth:"12.01.1978"},
    { nr:38, last: "Schmidhuber", first:"Andreas", birth:"03.06.1988"},
    { nr:39, last: "Schmidhuber", first:"Florian", birth:"25.04.1990"},
    { nr:40, last: "Schmidhuber", first:"Simon", birth:"15.12.2000"},
    { nr:41, last: "Schoosleitner", first:"Christian", birth:"22.02.1987"},
    { nr:42, last:"Schoosleitner", first:"Michael", birth:"14.02.1983"},
    { nr:43, last:"Schoosleitner", first:"Josef", birth:"20.03.1960"},
    { nr:44, last:"Stöllinger", first:"Hans", birth:"14.04.1960"},
    { nr:45, last:"Strumegger", first:"Benedikt", birth:"28.08.1988"},
    { nr:46, last:"Strumegger", first:"Bernhard", birth:"09.08.1970"},
    { nr:47, last:"Strumegger", first:"Felix (Fedda)", birth:"04.11.1998"},
    { nr:48, last:"Strumegger", first:"Florian", birth:"16.06.1976"},
    { nr:49, last:"Strumegger", first:"Josef", birth:"27.01.1958"},
    { nr:50, last:"Strumegger", first:"Sebastian", birth:"15.04.1991"},
    { nr:51, last:"Wesenauer", first:"Karl", birth:"09.05.1961"},
    { nr:52, last:"Willroider", first:"Herbert", birth:"08.05.1960"},
    { nr:53, last:"Winkler", first:"Robert", birth:"09.05.1995"},
    { nr:54, last:"Zoister", first:"Andreas", birth:"26.03.1990"},
    { nr:55, last:"Schmidhuber", first:"Natanael", birth:"25.01.2007"}
  ];

  // TT.MM.JJJJ -> YYYY-MM-DD
  function birthToKey(birth) {
    const p = birth.split('.');
    return `${p[2]}-${p[1]}-${p[0]}`;
  }

  function fmtTs(ts) {
    if (!ts) return '–';
    const d = new Date(ts);
    return d.toLocaleString('de-AT', {
      year:'numeric',month:'2-digit',day:'2-digit',
      hour:'2-digit',minute:'2-digit',second:'2-digit'
    });
  }

  function setErr(msg) {
    const box = document.getElementById('err');
    if (!msg) { box.style.display='none'; box.textContent=''; return; }
    box.style.display='block';
    box.textContent = msg;
  }

  let lastEligibleRows = []; // für CSV Export

  async function reloadAll() {
    setErr(null);

    // Platzhalter
    document.getElementById('tbEligibleVoted').innerHTML = `<tr><td colspan="5" class="muted">Daten werden geladen …</td></tr>`;
    document.getElementById('tbEligibleNotVoted').innerHTML = `<tr><td colspan="5" class="muted">Daten werden geladen …</td></tr>`;
    document.getElementById('tbNotEligible').innerHTML = `<tr><td colspan="5" class="muted">Daten werden geladen …</td></tr>`;
    document.getElementById('tbPresentUnknown').innerHTML = `<tr><td colspan="3" class="muted">Daten werden geladen …</td></tr>`;

    try {
      // parallel laden
      const [presentSnap, votesSnap] = await Promise.all([
        db.ref('present').once('value'),
        db.ref('votes').once('value')
      ]);

      const presentObj = presentSnap.val() || {};
      const votesObj = votesSnap.val() || {};

      // present keys (anwesend)
      const presentKeys = new Set(
        Object.keys(presentObj).filter(k => presentObj[k] === true)
      );

      // member map: key -> member
      const memberByKey = new Map();
      members.forEach(m => memberByKey.set(birthToKey(m.birth), m));

      // Stats vorbereiten
      const eligibleVoted = [];
      const eligibleNotVoted = [];
      const notEligible = [];

      // Für CSV: alle stimmberechtigten Mitglieder
      lastEligibleRows = [];

      // Mitglieder klassifizieren
      members.forEach(m => {
        const key = birthToKey(m.birth);
        const isPresent = presentKeys.has(key);
        const vote = votesObj[key] || null;

        if (isPresent) {
          // stimmberechtigt
          const row = { ...m, key, vote };
          lastEligibleRows.push(row);

          if (vote) eligibleVoted.push(row);
          else eligibleNotVoted.push(row);
        } else {
          notEligible.push({ ...m, key, vote });
        }
      });

      // present-keys, die nicht in members vorkommen
      const presentUnknown = [];
      presentKeys.forEach(k => {
        if (!memberByKey.has(k)) presentUnknown.push(k);
      });
      presentUnknown.sort();

      // Stats setzen
      document.getElementById('stMembers').textContent = members.length;
      document.getElementById('stPresent').textContent = presentKeys.size;
      document.getElementById('stEligibleVoted').textContent = eligibleVoted.length;
      document.getElementById('stEligibleNotVoted').textContent = eligibleNotVoted.length;
      document.getElementById('stNotEligible').textContent = notEligible.length;
      document.getElementById('stPresentUnknown').textContent = presentUnknown.length;

      // Tabellen füllen
      fillEligibleVoted(eligibleVoted);
      fillEligibleNotVoted(eligibleNotVoted);
      fillNotEligible(notEligible);
      fillPresentUnknown(presentUnknown);

    } catch (e) {
      console.error(e);
      setErr(
        `Fehler beim Laden.\n\n` +
        `Typisch ist "permission_denied" => Rules erlauben das Lesen nicht.\n\n` +
        `Details: ${e?.message || e}`
      );
    }
  }

  function fillEligibleVoted(list) {
    const tb = document.getElementById('tbEligibleVoted');
    tb.innerHTML = '';
    if (!list.length) {
      tb.innerHTML = `<tr><td colspan="5" class="muted">Noch keine stimmberechtigte Stimme vorhanden.</td></tr>`;
      return;
    }
    list.sort((a,b)=>a.nr-b.nr).forEach(m => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${m.nr}</td>
        <td>${m.last}</td>
        <td>${m.first}</td>
        <td>${m.birth}</td>
        <td class="ok">${fmtTs(m.vote?.ts)}</td>
      `;
      tb.appendChild(tr);
    });
  }

  function fillEligibleNotVoted(list) {
    const tb = document.getElementById('tbEligibleNotVoted');
    tb.innerHTML = '';
    if (!list.length) {
      tb.innerHTML = `<tr><td colspan="5" class="muted">Alle stimmberechtigten Mitglieder haben abgestimmt.</td></tr>`;
      return;
    }
    list.sort((a,b)=>a.nr-b.nr).forEach(m => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${m.nr}</td>
        <td>${m.last}</td>
        <td>${m.first}</td>
        <td>${m.birth}</td>
        <td class="warn">Noch keine Stimme</td>
      `;
      tb.appendChild(tr);
    });
  }

  function fillNotEligible(list) {
    const tb = document.getElementById('tbNotEligible');
    tb.innerHTML = '';
    if (!list.length) {
      tb.innerHTML = `<tr><td colspan="5" class="muted">Alle Mitglieder sind als anwesend markiert.</td></tr>`;
      return;
    }
    list.sort((a,b)=>a.nr-b.nr).forEach(m => {
      const tr = document.createElement('tr');
      const hasVote = !!m.vote;
      tr.innerHTML = `
        <td>${m.nr}</td>
        <td>${m.last}</td>
        <td>${m.first}</td>
        <td>${m.birth}</td>
        <td class="${hasVote ? 'bad' : 'muted'}">${hasVote ? 'Hat Stimme, aber nicht anwesend?!' : 'Nicht anwesend'}</td>
      `;
      tb.appendChild(tr);
    });
  }

  function fillPresentUnknown(keys) {
    const tb = document.getElementById('tbPresentUnknown');
    tb.innerHTML = '';
    if (!keys.length) {
      tb.innerHTML = `<tr><td colspan="3" class="muted">Keine unbekannten present-Einträge.</td></tr>`;
      return;
    }
    keys.forEach((k, idx) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${k}</td>
        <td class="warn">Anwesend, aber nicht in Mitgliederliste</td>
      `;
      tb.appendChild(tr);
    });
  }

  function exportCSV() {
    // exportiert NUR stimmberechtigte (present) Mitglieder
    if (!lastEligibleRows || !lastEligibleRows.length) {
      alert('Keine Daten für Export vorhanden (noch nicht geladen oder niemand stimmberechtigt).');
      return;
    }

    const header = ['Nr','Nachname','Vorname','Geburtsdatum','Key(YYYY-MM-DD)','Status','Zeit'];
    const lines = [header.join(';')];

    lastEligibleRows
      .slice()
      .sort((a,b)=>a.nr-b.nr)
      .forEach(m => {
        const status = m.vote ? 'ABGESTIMMT' : 'OFFEN';
        const time = m.vote ? fmtTs(m.vote.ts) : '';
        const row = [
          m.nr,
          m.last,
          m.first,
          m.birth,
          m.key,
          status,
          time
        ].map(x => String(x ?? '').replace(/;/g, ','));
        lines.push(row.join(';'));
      });

    const csv = '\uFEFF' + lines.join('\n'); // BOM für Excel
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = 'stimmberechtigt_status.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // Start
  reloadAll();
</script>

</body>
</html>
